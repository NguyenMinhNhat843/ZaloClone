<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Simple Chat</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        height: 100vh;
        margin: 0;
      }

      .sidebar {
        width: 30%;
        border-right: 1px solid #ccc;
        padding: 10px;
      }

      .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 10px;
      }

      .chat-box {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .message {
        padding: 8px;
        border-radius: 5px;
        max-width: 70%;
      }

      .sent {
        background-color: #dcf8c6;
        align-self: flex-end;
        text-align: right;
      }

      .received {
        background-color: #eee;
        align-self: flex-start;
        text-align: left;
      }

      .input-row {
        display: flex;
        gap: 5px;
      }

      .conversation {
        padding: 8px;
        cursor: pointer;
        border-bottom: 1px solid #ddd;
      }

      .conversation:hover {
        background-color: #f0f0f0;
      }

      .conversation.active {
        background-color: #e0e0e0;
        font-weight: bold;
      }

      .login-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
    </style>
  </head>

  <body>
    <div class="sidebar">
      <h3>Conversations</h3>
      <div class="login-buttons">
        <button onclick="loginAs('user1')">Login User 1</button>
        <button onclick="loginAs('user2')">Login User 2</button>
      </div>
      <div id="conversationList"></div>
    </div>

    <div class="chat-area">
      <h3 id="currentReceiver">Select a conversation</h3>
      <div class="chat-box" id="chatBox"></div>
      <div class="input-row">
        <input
          type="text"
          id="msgInput"
          placeholder="Type a message..."
          style="flex: 1"
        />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <script>
      const baseUrl = 'http://localhost:3000';
      const socket = io(baseUrl, { transports: ['websocket'] });

      socket.on('connect', () => {
        console.log(
          '[Client] ‚úÖ Socket connected successfully with id:',
          socket.id,
        );
      });

      const USERS = {
        user1: {
          id: '67f7a6fd3d052b87fbce7830',
          phone: '0147258369',
          password: '123456',
          name: 'User demo chat 1',
        },
        user2: {
          id: '67f7a7133d052b87fbce7834',
          phone: '015893246',
          password: '123456',
          name: 'User demo chat 2',
        },
      };

      let currentUser = null;
      let token = '';
      let currentReceiverId = null;
      let currentConversationId = null;

      // login ƒë·ªÉ test
      function loginAs(userKey) {
        const user = USERS[userKey];
        fetch(`${baseUrl}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ phone: user.phone, password: user.password }),
        })
          .then((res) => res.json())
          .then((data) => {
            token = data.accessToken;
            currentUser = user;

            console.log('[Client] Logged in as:', currentUser.name);
            console.log(
              '[Client] Emitting joinChat with userId:',
              currentUser.id,
            );

            // ===================================== X·ª≠ l√Ω socket ====================================
            // Khi ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p th√†nh c√¥ng, tham gia v√†o ph√≤ng chat
            // socket.emit('joinChat', currentUser.id);
            console.log({ userId: currentUser.id });
            socket.emit('joinChat', { userId: currentUser.id });
            fetchConversations();
            alert(`${user.name} logged in`);
          });
      }

      // ================= L·∫•y ƒëo·∫°n h·ªôi tho·∫°i ===============
      function fetchConversations() {
        fetch(`${baseUrl}/chat/conversations/${currentUser.id}`, {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((res) => res.json())
          .then((data) => {
            const list = document.getElementById('conversationList');
            list.innerHTML = '';
            data.forEach((conv) => {
              const div = document.createElement('div');
              div.className = 'conversation';

              // ‚úÖ HTML ch·ª©a avatar + t√™n cu·ªôc h·ªôi tho·∫°i
              div.innerHTML = `
          <div style="display: flex; align-items: center; gap: 10px;">
            <img src="${conv.groupAvatar || 'https://via.placeholder.com/40'}" width="40" height="40" style="border-radius: 50%;" />
            <span>${conv.nameConversation || conv.title}</span>
          </div>
        `;

              div.onclick = () => selectConversation(conv);
              list.appendChild(div);
            });
          });
      }

      // ================== Ch·ªçn ƒëo·∫°n h·ªôi tho·∫°i ===============
      // ================== Loai tin nh·∫Øn ===============
      function selectConversation(conv) {
        // converid hi·ªán t·∫°i
        currentConversationId = conv._id;
        currentReceiverId = conv.participants.find((p) => p !== currentUser.id);

        document.getElementById('currentReceiver').textContent =
          `Chat with ${currentReceiverId}`;
        document
          .querySelectorAll('.conversation')
          .forEach((el) => el.classList.remove('active'));
        event.target.classList.add('active');

        fetch(`${baseUrl}/chat/messages/${currentConversationId}`, {
          headers: { Authorization: `Bearer ${token}` },
        })
          .then((res) => res.json())
          .then((data) => {
            console.log(data);
            const box = document.getElementById('chatBox');
            box.innerHTML = '';
            data.forEach((msg) => {
              const type =
                msg.senderId === currentUser.id ? 'sent' : 'received';
              // ================ 1 d√≤ng tin nh·∫Øn n√® =============
              const label =
                msg.sender._id === USERS.user1.id
                  ? 'User1'
                  : msg.sender._id === USERS.user2.id
                    ? 'User2'
                    : 'Unknown';
              appendMessage(`${label}: ${msg.text}`, type);
            });
          });
      }

      // g·ª≠i tin nh·∫Øn
      function sendMessage() {
        const msg = document.getElementById('msgInput').value;
        if (!msg || !currentReceiverId) return;
        const body = {
          senderId: currentUser.id,
          receiverId: currentReceiverId,
          text: msg,
        };
        console.log('[Client] Sending message:', body);

        // ============================= D√πng socket ·ªü ƒë√¢y nha ===============================
        socket.emit('sendMessage', body);

        const label = currentUser.id === USERS.user1.id ? 'User1' : 'User2';
        appendMessage(`${label}: ${msg}`, 'sent');
        document.getElementById('msgInput').value = '';
      }

      // H√†m x·ª≠ l√Ω hi·ªÉn th·ªã
      function appendMessage(text, type) {
        const box = document.getElementById('chatBox');
        const div = document.createElement('div');
        div.className = `message ${type}`;
        div.textContent = text;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
      }

      socket.on('joinedChat', ({ userId, rooms }) => {
        console.log(`[Client] Successfully joined chat for user ${userId}`);
        console.log('[Client] Current rooms:', rooms);
      });

      // ================================= X·ª≠ l√Ω socket ====================================
      // Khi ng∆∞·ªùi d√πng tham gia v√†o ph√≤ng chat, nh·∫≠n tin nh·∫Øn t·ª´ server
      socket.on('receiveMessage', (msg) => {
        console.log('[Client] üì© Received message:', msg);

        if (!currentUser) {
          console.warn('[Client] ‚ùå currentUser is null');
          return;
        }

        console.log('[Client] currentUser:', currentReceiverId);

        const isMine = msg.senderId === currentUser.id; // ki·ªÉm tra xem hi·ªán t·∫°i c√≥ ph·∫£i ng∆∞·ªùi g·ª≠i ko
        const isCurrent = [msg.senderId, msg.receiverId].includes(
          currentReceiverId,
        ); // ki·ªÉm tra xem hi·ªán t·∫°i c√≥ ph·∫£i ng∆∞·ªùi nh·∫≠n ko

        console.log('[Client] isMine:', isMine, 'isCurrent:', isCurrent);

        if (isCurrent) {
          const label =
            msg.senderId === USERS.user1.id
              ? 'User1'
              : msg.senderId === USERS.user2.id
                ? 'User2'
                : 'Unknown';

          appendMessage(`${label}: ${msg.text}`, isMine ? 'sent' : 'received');
        }
      });
    </script>
  </body>
</html>
